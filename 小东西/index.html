<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Mon cœur</title>
  <style>
    html,body{height:100%;margin:0;background:#fff;color:#111;overflow:hidden;}
    #wrap{position:relative;width:100%;height:100%;}
    #stage{position:absolute;inset:0;width:100%;height:100%;display:block;background:#fff;}
    .hint{position:absolute;right:10px;top:10px;font:12px/1.2 system-ui,-apple-system,Segoe UI,Roboto,PingFang SC,Hiragino Sans GB,Microsoft YaHei,sans-serif;color:#888;}
  </style>
</head>
<body>
  <div id="wrap">
    <canvas id="stage"></canvas>
    <div class="hint">点按任意位置放烟花</div>
  </div>
<script>
(function(){
  const canvas = document.getElementById('stage');
  const ctx = canvas.getContext('2d');

  // ===== DPR 与自适应 =====
  const state = {
    sw:0, sh:0, k:1,
    throb:0, dir:0,
    particle_limit:16,
    particle_num:32,
    point_density:0.10,
    points:[],
    fireworks:[],
    dmTexts:['文琪：','Eddy想对你说：',"Je t'aime de tout mon coeur."],
    dmState:[],
    DM_SPEED:1.2,    // 弹幕速度（px/帧）→越小越慢
    DM_GAP:800       // 弹幕句间隔（毫秒）
  };

  function resize(){
    const dpr = Math.max(1, window.devicePixelRatio || 1);
    const w = canvas.clientWidth || window.innerWidth;
    const h = canvas.clientHeight || window.innerHeight;
    canvas.width = Math.floor(w * dpr);
    canvas.height = Math.floor(h * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
    state.sw = w; state.sh = h;
    seedHeart();
  }
  window.addEventListener('resize', resize, {passive:true});

  // ===== 天数 =====
  function daysLabel(){
    const start = new Date('2025-05-17T00:00:00');
    const days = Math.floor((new Date() - start)/86400000);
    return `我们在一起 ${days} 天了`;
  }

  // ===== 心形点云 =====
  function seedHeart(){
    const BASE = 544;
    state.k = Math.min(state.sw, state.sh) * 0.58 / BASE; // 调大小改 0.58
    state.points = [];
    for(let t=0; t<=Math.PI*2; t+= state.point_density){
      const arr = [];
      for(let i=0;i<=state.particle_num;i++){
        arr[i] = {
          x:(Math.random()*2*state.particle_limit - state.particle_limit),
          y:(Math.random()*2*state.particle_limit - state.particle_limit),
          size:Math.random()*1.8+0.2,
          vx:Math.random()*1.0-0.5,
          vy:Math.random()*1.0-0.5
        };
      }
      state.points.push(arr);
    }
  }

  // ===== 烟花 =====
  function spawnFirework(x,y){
    const n = 36, arr=[];
    for(let i=0;i<n;i++){
      const ang = Math.random()*Math.PI*2;
      const spd = 1.2 + Math.random()*1.6;
      arr.push({x,y,vx:Math.cos(ang)*spd,vy:Math.sin(ang)*spd-0.6,life:1.0});
    }
    state.fireworks.push(arr);
  }
  function drawFireworks(dt){
    const g = 0.04;
    for(let f=state.fireworks.length-1; f>=0; f--){
      const parts = state.fireworks[f];
      for(let i=parts.length-1; i>=0; i--){
        const p = parts[i];
        p.life -= dt*0.6; if(p.life<=0){ parts.splice(i,1); continue; }
        p.vy += g; p.x += p.vx*8; p.y += p.vy*8;
        ctx.beginPath(); ctx.arc(p.x,p.y,2,0,Math.PI*2);
        ctx.fillStyle = `rgba(225,20,20,${p.life})`; ctx.fill();
      }
      if(parts.length===0) state.fireworks.splice(f,1);
    }
  }
  canvas.addEventListener('pointerdown', e=>{
    const r = canvas.getBoundingClientRect();
    spawnFirework(e.clientX - r.left, e.clientY - r.top);
  }, {passive:true});

  // ===== 弹幕 =====
  function startDanmaku(){
    state.dmState = new Array(state.dmTexts.length).fill(null);
    const sw = state.sw, sh = state.sh;
    const rows = [ sh*0.16, sh*0.18, sh*0.20 ];
    const speed = state.DM_SPEED, gap = state.DM_GAP;

    function launch(idx){
      if(idx>=state.dmTexts.length) return;
      let x = sw + 10; const y = rows[idx];
      const widthEst = measureText(state.dmTexts[idx], 20);
      function tick(){
        x -= speed;
        state.dmState[idx] = {active:true,x,y};
        if(x > -widthEst - 30){ requestAnimationFrame(tick); }
        else { state.dmState[idx]={active:false,x:-9999,y}; setTimeout(()=>launch(idx+1), gap); }
      }
      tick();
    }
    setTimeout(()=>launch(0), gap);
  }
  function measureText(text, size){
    ctx.save(); ctx.font = size+'px sans-serif';
    const w = ctx.measureText(text).width; ctx.restore(); return w;
  }

  // ===== 心跳 =====
  function beat(){
    state.throb += (state.dir===0 ? 0.15 : -0.15);
    if(state.throb <= 0) state.dir = 0;
    if(state.throb >= 1.5) state.dir = 1;
    setTimeout(beat, 40);
  }

  // ===== 绘制 =====
  function drawCluster(x,y,arr){
    ctx.fillStyle = '#E10600';
    for(let i=0;i<state.particle_num;i++){
      const p = arr[i];
      ctx.beginPath(); ctx.arc(p.x+x,p.y+y,p.size,0,Math.PI*2); ctx.fill();
      p.x += p.vx; p.y += p.vy;
      if(p.x + x < -state.particle_limit + x || p.x + x > state.particle_limit + x) p.vx = -p.vx;
      if(p.y + y < -state.particle_limit + y || p.y + y > state.particle_limit + y) p.vy = -p.vy;
    }
  }

  function render(){
    const sw = state.sw, sh = state.sh;
    ctx.clearRect(0,0,sw,sh);
    ctx.fillStyle = '#fff'; ctx.fillRect(0,0,sw,sh);

    const s = 16 * state.k;
    let i=0;
    for(let t=0; t<=Math.PI*2; t+= state.point_density){
      let ix = (16 + state.throb) * Math.pow(Math.sin(t), 3);
      let iy = -((13 + state.throb) * Math.cos(t) - 5*Math.cos(2*t) - (2 + state.throb)*Math.cos(3*t) - Math.cos(4*t));
      ix *= s; iy *= s;
      drawCluster(sw/2 + ix, sh/2 + iy, state.points[i]);
      i++;
    }

    drawFireworks(0.016);

    ctx.save();
    ctx.fillStyle = '#e10600';
    ctx.font = '18px sans-serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'alphabetic';
    ctx.fillText(daysLabel(), sw/2, sh - 16);
    ctx.restore();

    ctx.save();
    ctx.fillStyle = '#111';
    ctx.font = '20px sans-serif';
    ctx.textAlign = 'left';
    ctx.textBaseline = 'top';
    for(let k=0;k<state.dmTexts.length;k++){
      const s = state.dmState[k];
      if(s && s.active) ctx.fillText(state.dmTexts[k], s.x, s.y);
    }
    ctx.restore();

    requestAnimationFrame(render);
  }

  // 启动
  resize();
  seedHeart();
  startDanmaku();
  beat();
  requestAnimationFrame(render);
})();
</script>
</body>
</html>
